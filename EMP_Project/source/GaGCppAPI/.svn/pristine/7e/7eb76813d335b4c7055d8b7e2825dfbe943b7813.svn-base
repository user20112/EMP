/**
 * @file LibVersionInfo.template.cpp
 * @short source is generated during building project and contains build version and date. Additional several SVN parameter can be requested.
 *
 * Version Information
 * -------------------
 * $Revision: 29111 $
 * $HeadURL: https://app-aug-svn01.aug.osram.de/svn/aug-sw/TASKS/SOFTWARE/LIBS/CPP/Gamma_IOPlugins/PlugInTemplate/trunk/src/PlugInVersionInfo.template.cpp $
 * $Author: S.Hegemann $
 * $Date: 2014-11-20 11:46:22 +0100 (Do, 20 Nov 2014) $
 *
 */

#include <iostream>
#include <iomanip>
#include <sstream>

#include "LibVersionInfo.h"
#include "Config.h"

using namespace std;

// these defines are generated by SubWCRev and contain all SVN informations
/**
 * @short latest revision number or -1 when no subverion information is available
 */
#define SVN_VERSION_AVAILABLE               $WCREV$
/**
 * @short date and time of last commit
 */
#define SVN_COMMIT_DATE                     "$WCDATE=%Y-%m-%d %H:%M$"
/**
 * @short date and time of last information update
 */
#define SVN_BUILD_DATE                      "$WCNOW=%Y-%m-%d %H:%M$"
/**
 * @short latest revision number as text
 */
#define SVN_REVISION_NO                     "$WCREV$"
/**
 * @short range of revisions (format "lowest:highest")
 */
#define SVN_REVISION_RANGE                  "$WCRANGE$"
/**
 * @short when several versions are mixed this \c SNV_REVISION include the revision range, otherwise the latest revision
 */
#define SNV_REVISION                        $WCMIXED?SVN_REVISION_RANGE:SVN_REVISION_NO$
/**
 * @short is true, when file with local modifications are used for this build, otherwise false
 */
#define SVN_LOCAL_MODIFICATIONS             $WCMODS?true:false$
/**
 * @short is true, when unversioned files are used for this build, otherwise false
 */
#define SVN_UNVERSIOND_FILES                $WCUNVER?true:false$
/**
 * @short is true, when the code is marked as tagged, otherwise false
 */
#define SVN_TAGGED_VERSION                  $WCISTAGGED?true:false$
/**
 * @short URL of used subverion repository
 */
#define SVN_URL                             "$WCURL$"

namespace GaGCppAPI {

    // **************************************************************************************************
    // ** LibVersionInfo
    // **************************************************************************************************
    LibVersionInfo::LibVersionInfo()
    {
        mLibName = APPLICATION_NAME;
        mBuildDescription = BUILD_DESC;
        mBuildTime = __DATE__;
        mBuildTime += " - ";
        mBuildTime += __TIME__;

        mMajorVersion = VERSION_MAJOR;
        mMinorVersion = VERSION_MINOR;
        mVersionPatch = VERSION_PATCH;
        mVersionTweak = VERSION_TWEAK;

        if ((mMajorVersion > 0xff) || (mMinorVersion > 0xfff) || (mVersionPatch > 0xfff)) {
            cerr << "current version information exceeds limit" << endl;
            mInternalVersionInfo = 0;
        }
        else {
            mInternalVersionInfo = ((VERSION_MAJOR << 24) | (VERSION_MINOR << 12) | (VERSION_PATCH));
        }

#if defined NDEBUG
        mIsDebugVersion = false;
#else
        mIsDebugVersion = true;
#endif

#if (SVN_VERSION_AVAILABLE > 0)
        mHasSvnInformations = true;

        mSvnRevision = SVN_VERSION_AVAILABLE;
        mSvnRevisionRange = SNV_REVISION;
        mSvnDateCommit = SVN_COMMIT_DATE;
        mSvnBuildDate = SVN_BUILD_DATE;
        mSvnURL = SVN_URL;
        mSvnHasLocalModifications = SVN_LOCAL_MODIFICATIONS;
        mSvnHasUnversionedFiles = SVN_UNVERSIOND_FILES;
        mSvnIsTaggedVersion = SVN_TAGGED_VERSION;
#else
        mHasSvnInformations = false;

        mSvnRevision = 0;
        mSvnRevisionRange = "0";
        mSvnDateCommit = "";
        mSvnBuildDate = mBuildTime;
        mSvnURL = "";
        mSvnHasLocalModifications = true;
        mSvnHasUnversionedFiles = true;
        mSvnIsTaggedVersion = false;
#endif
    }

    // **************************************************************************************************
    // ** ~LibVersionInfo
    // **************************************************************************************************
    LibVersionInfo::~LibVersionInfo()
    {
    }

    // **************************************************************************************************
    // ** getInstance
    // **************************************************************************************************
    LibVersionInfo&
    LibVersionInfo::getInstance()
    {
        static LibVersionInfo instance;
        return (instance);
    }

    // **************************************************************************************************
    // ** getVersionText
    // **************************************************************************************************
    std::string
    LibVersionInfo::getVersionText () const
    {
        stringstream ss;
        ss << setw(2) << setfill('0') << mMajorVersion << "."
           << setw(3) << setfill('0') << mMinorVersion << "."
           << setw(3) << setfill('0') << mVersionPatch
           << (mIsDebugVersion ? " [Debug] " : "")
           << " -- Date of Build: " << mBuildTime;

        return (ss.str());
    }

    // **************************************************************************************************
    // ** printInfo
    // **************************************************************************************************
    void
    LibVersionInfo::printInfo() const
    {
        if (mBuildDescription.length() > 0) {
            cout << mLibName << " -- " << mBuildDescription << endl;
        }
        else {
            cout << mLibName << " Version information" << endl;
        }

        cout << "    Current Version: " << getVersionText() << endl;

        if (mHasSvnInformations) {
            cout << "    SVN-URL: " << mSvnURL << endl
                    << "    Revision " << mSvnRevision
                    << (mSvnHasLocalModifications ? " (including local modifications)" : "")
                    << (mSvnHasUnversionedFiles ? " (including unversioned files)" : "")
                    << (mSvnIsTaggedVersion ? " (Tagged version)" : "")
                    << " committed on " << mSvnDateCommit
                    << endl;
        }
        else {
            cout << "    No SVN-Information available." << endl;
        }
    }

}    // namespace GaGCppAPI
